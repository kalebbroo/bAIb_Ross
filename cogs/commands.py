import discord
from discord.ext import commands
from discord import app_commands
from discord.ui import Button, View, Select, Modal, TextInput
from config import SHOWCASE_ID
import requests
from typing import List
import asyncio
import time
import aiohttp
from payload import Payload


async def model_autocomplete(current: str = ""):
    # Make a GET request to the API to fetch the list of available models
    response = requests.get('http://localhost:7860/sdapi/v1/sd-models')

    # Check if the request was successful
    if response.status_code == 200:
        # Parse the JSON response
        models = response.json()

        # Extract the model names and create a list of choices
        model_list = [model['model_name'] for model in models if current.lower() in model['model_name'].lower()]
        # Create a formatted string with each model on a new line, preceded by its number
        formatted_list = "\n".join(f"{i+1}. {model}" for i, model in enumerate(model_list))
        return formatted_list


    else:
        return ""




class Commands(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self._last_member = None
        self.eta_task = None


    @app_commands.command(name="dream", description="Press ENTER to Generate an image")
    async def dream(self, interaction):
        #await interaction.followup.send(f"Generating Prompt Creator...", ephemeral=True)
        # Create the modal and open it
        current = ""
        formatted_list = await model_autocomplete(current)
        modal = self.Txt2imgModal(self.bot, formatted_list)
        await interaction.response.send_modal(modal)


    async def update_eta(self, interaction):
        start_time = time.time()
        eta_message = None
        while True:
            eta = await get_eta()
            if eta > 0.0 or time.time() - start_time > 30:
                if eta_message:
                    await eta_message.edit(content=f"Estimated Generation Time: {int(eta)} seconds")
                else:
                    eta_message = await interaction.channel.send(f"Estimated Generation Time: {int(eta)} seconds")
            if eta <= 0.0 or time.time() - start_time > 30:
                break
            await asyncio.sleep(0.5)


    async def create_embed(self, interaction, prompt, negative, steps, seed, cfg_scale, width=512, height=512):
        user = interaction.user
        title = f"Generated by {user.name}"
        description = f"Prompt: {prompt}\nNegative: {negative}"
        footer_text = f"Steps: {steps}, Seed: {seed}, CFG Scale: {cfg_scale}, Width: {width}, Height: {height}"

        embed = discord.Embed(
            title=title,
            description=description,
            color=6301830
        )
        embed.set_image(url="attachment://temp.png")
        embed.set_footer(text=footer_text)
        embed.set_author(name=user.name, icon_url=user.avatar.url)

        return embed
    

    class Txt2imgModal(Modal):
        def __init__(self, bot, formatted_list):
            super().__init__(title="Enter Prompt and change settings")
            self.bot = bot
            self.formatted_list = formatted_list
            self.eta_task = None

            # Add a TextInput for the prompt
            self.prompt = TextInput(label='Format must be [Prompt: Negative:]',
                                    style=discord.TextStyle.paragraph,
                                    default='Prompt: A happy little tree Negative: nsfw',
                                    min_length=1,
                                    max_length=2000,
                                    required=True)
            self.model = TextInput(label='Choose 1 Model, delete the rest',
                                            style=discord.TextStyle.paragraph,
                                            #placeholder=f'{model}',
                                            default=f'{formatted_list}',
                                            min_length=1,
                                            max_length=2000,
                                            required=False)
            self.settings = TextInput(label='Enter values to change settings',
                                            style=discord.TextStyle.paragraph,
                                            placeholder='Enter your settings here',
                                            default="Steps: 10, Seed: -1, CFG Scale: 0.9, Width: 512, Height: 512",
                                            min_length=1,
                                            max_length=2000,
                                            required=False)
            self.styles = TextInput(label='Choose Styles and VAE',
                                            style=discord.TextStyle.paragraph,
                                            placeholder='Choose Styles LORA VAE',
                                            default="pre filled out text",
                                            min_length=1,
                                            max_length=2000,
                                            required=False)
            # Add the TextInput components to the modal
            self.add_item(self.prompt)
            self.add_item(self.styles)
            self.add_item(self.model)
            self.add_item(self.settings)

        async def on_submit(self, interaction):
            await interaction.response.defer()

            prompt = self.prompt.value
            await interaction.followup.send(f"Creating image from prompt: {prompt}", ephemeral=True)

            styles = self.styles.value
            model = self.model.value
            settings = self.settings.value

            prompt, negative, model, steps, seed, cfg_scale = await self.sort_modal_response(interaction, prompt, styles, 
                                                                          model, settings)

            # Create an instance of the Payload class
            payload_instance = Payload(self.bot)

            # Create the payload
            payload = await payload_instance.create_payload(prompt, negative, steps, seed, cfg_scale)

            # Call the text2image function with the created payload
            response_data, payload = await self.bot.get_cog('Text2Image').txt2image(payload)

            # Start the ETA task
            self.eta_task = asyncio.ensure_future(self.bot.get_cog('Commands').update_eta(interaction))

            image_file = await self.bot.get_cog('Text2Image').pull_image(response_data)
            # Create an instance of the ImageView
            buttons = self.bot.get_cog('Buttons').ImageView(interaction, response_data['images'], payload)
            self.bot.get_cog('Buttons').payload = payload

            embed = await self.bot.get_cog('Commands').create_embed(interaction, prompt, negative, steps, seed, cfg_scale)
            await interaction.channel.send(embed=embed, file=image_file, view=buttons)

            # Store the payload in the Buttons cog
            self.bot.get_cog('Buttons').payload = payload

            print(f"{interaction.user.display_name} Dreampt of {prompt}")

            # Cancel the ETA task
            if self.eta_task and not self.eta_task.done():
                self.eta_task.cancel()
                self.eta_task = None

        async def sort_modal_response(self, interaction, prompt, styles, model, settings):
            # Split prompt and negative from modal text
            parts = prompt.split("Negative:")
            prompt = parts[0].replace("Prompt:", "").strip()
            negative = parts[1].strip() if len(parts) > 1 else None

            # split styles
            #Todo: make the logic
            styles = styles

            # Make sure there is only 1 model
            #Todo: make the logic 
            models = await model_autocomplete("")
            for item in models:
                if item == model:
                    pass
                else:
                    model = "disneyPixarCartoon_v10"

            # split the settings and check for valid values
            settings = settings
            cfg_scale = 0.7
            seed = -1
            steps = 10

            return prompt, negative, model, steps, seed, cfg_scale,
            







async def get_eta():
    url = "http://localhost:7860/sdapi/v1/progress"
    params = {"skip_current_image": "false"}
    async with aiohttp.ClientSession() as session:
        async with session.get(url, params=params) as response:
            if response.status == 200:
                data = await response.json()
                eta = data["eta_relative"]
                return eta
            else:
                return None





async def setup(bot):
    await bot.add_cog(Commands(bot))
    